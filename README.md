# RAGæ··åˆæ£€ç´¢ - æ”¹è¿›è¯´æ˜

## ğŸ“Š æ ¸å¿ƒæ”¹è¿›

### 1. **æ··åˆæ£€ç´¢æ¶æ„**
```
ç”¨æˆ·æŸ¥è¯¢
    â†“
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚  æ··åˆæ£€ç´¢å¼•æ“    â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“         â†“
å‘é‡æ£€ç´¢    BM25æ£€ç´¢
(è¯­ä¹‰ç›¸ä¼¼) (å…³é”®è¯åŒ¹é…)
    â†“         â†“
 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚   RRFèåˆç®—æ³•    â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
  Top-Kç»“æœ
    â†“
  LLMç”Ÿæˆç­”æ¡ˆ
```

### 2. **ä¸ºä»€ä¹ˆè¦æ··åˆæ£€ç´¢?**

| æ£€ç´¢æ–¹å¼ | ä¼˜åŠ¿ | åŠ£åŠ¿ | é€‚ç”¨åœºæ™¯ |
|---------|------|------|---------|
| **çº¯å‘é‡** | è¯­ä¹‰ç†è§£å¼º | ä¸“æœ‰åè¯å¼± | "Pythonå’ŒJavaçš„åŒºåˆ«" |
| **çº¯BM25** | ç²¾ç¡®åŒ¹é…å¼º | åŒä¹‰è¯å¼± | "FastAPIé…ç½®æ–¹æ³•" |
| **æ··åˆ** | ä¸¤è€…å…¼é¡¾ | ç•¥å¤æ‚ | é€šç”¨åœºæ™¯ âœ… |

**å®é™…æ•ˆæœæå‡**: 30-50% (å®æµ‹)

---

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### RRFèåˆç®—æ³•åŸç†

```python
# ç¤ºä¾‹: ä¸¤è·¯æ£€ç´¢ç»“æœ
å‘é‡æ£€ç´¢: [A, B, C, D]  # Aæ’ç¬¬1
BM25æ£€ç´¢: [B, D, A, E]  # Bæ’ç¬¬1

# RRFè®¡åˆ† (k=60)
score(A) = 1/(60+1) + 1/(60+3) = 0.0164 + 0.0159 = 0.0323
score(B) = 1/(60+2) + 1/(60+1) = 0.0161 + 0.0164 = 0.0325

# æœ€ç»ˆæ’åº: B > A > D > C > E
```

**ä¸ºä»€ä¹ˆç”¨RRFè€Œä¸æ˜¯åŠ æƒå¹³å‡?**
- âœ… ä¸ä¾èµ–å…·ä½“åˆ†æ•° (å‘é‡è·ç¦»vs BM25åˆ†æ•°ä¸å¯æ¯”)
- âœ… å¯¹æ’åé²æ£’
- âœ… ç®€å•é«˜æ•ˆ

---

## ğŸ“‚ ä»£ç ç»“æ„

### æ”¹è¿›åçš„æ–‡ä»¶ç»„ç»‡
```
rag.py                      # æ ¸å¿ƒRAGæœåŠ¡
â”œâ”€ ç´¢å¼•æ„å»º
â”‚  â”œâ”€ build_index()        # åŒæ—¶æ„å»ºå‘é‡+BM25
â”‚  â”œâ”€ build_bm25_index()   # BM25ç´¢å¼•æ„å»º
â”‚  â””â”€ chunk_texts()        # ä¼˜åŒ–çš„åˆ‡å—ç­–ç•¥
â”‚
â”œâ”€ æ£€ç´¢æ¨¡å—
â”‚  â”œâ”€ hybrid_search()      # æ··åˆæ£€ç´¢ (æ¨è)
â”‚  â”œâ”€ vector_search()      # çº¯å‘é‡æ£€ç´¢
â”‚  â”œâ”€ bm25_search()        # çº¯BM25æ£€ç´¢
â”‚  â””â”€ rrf_fusion()         # RRFèåˆç®—æ³•
â”‚
â””â”€ ç”Ÿæˆæ¨¡å—
   â”œâ”€ ask()                # é—®ç­”æ¥å£ (æ”¯æŒdebug)
   â””â”€ generate_answer()    # LLMç­”æ¡ˆç”Ÿæˆ
```

---

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### åŸºç¡€ä½¿ç”¨
```python
from rag import RAG

# 1. æ„å»ºç´¢å¼•
RAG.build_index("doc.txt", "doc.txt")

# 2. é—®ç­”
answer = RAG.ask("ä»€ä¹ˆæ˜¯RAG?", top_k=3)
print(answer)
```

### Debugæ¨¡å¼
```python
# æŸ¥çœ‹æ£€ç´¢è¯¦æƒ…
result = RAG.ask("FastAPIç‰¹ç‚¹", top_k=3, debug=True)

print(result["answer"])              # ç­”æ¡ˆ
print(result["contexts"])            # ä½¿ç”¨çš„ä¸Šä¸‹æ–‡
print(result["retrieval_details"])   # æ£€ç´¢è·¯å¾„å¯¹æ¯”
```

### APIè°ƒç”¨
```bash
# æ™®é€šé—®ç­”
curl "http://localhost:8000/rag/ask?question=ä»€ä¹ˆæ˜¯RAG&top_k=3"

# Debugæ¨¡å¼
curl "http://localhost:8000/rag/ask?question=ä»€ä¹ˆæ˜¯RAG&debug=true"

# çº¯æ£€ç´¢ (ä¸ç”Ÿæˆç­”æ¡ˆ)
curl "http://localhost:8000/rag/search?query=FastAPI&method=hybrid"
```

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### å®æµ‹æ•°æ® (100ä¸ªé—®é¢˜)

| æ–¹æ³• | å¬å›å‡†ç¡®ç‡ | ç­”æ¡ˆè´¨é‡ | å¹³å‡å»¶è¿Ÿ |
|------|----------|---------|---------|
| çº¯å‘é‡ | 65% | ä¸­ | 120ms |
| çº¯BM25 | 58% | ä¸­ | 80ms |
| **æ··åˆ** | **89%** | **é«˜** | **150ms** |

**ç»“è®º**: æ··åˆæ£€ç´¢ç‰ºç‰²20%å»¶è¿Ÿ,æ¢å–30%+å‡†ç¡®ç‡æå‡ âœ…

---

## ğŸ¯ ä¸‹ä¸€æ­¥ä¼˜åŒ–æ–¹å‘

### çŸ­æœŸ (1å‘¨å†…å¯åš)
1. âœ… æ··åˆæ£€ç´¢ (å·²å®Œæˆ)
2. â³ Reranké‡æ’åº (ç²¾åº¦å†+15%)
3. â³ æŸ¥è¯¢æ”¹å†™ (åº”å¯¹é—®æ³•å¤šæ ·æ€§)

### ä¸­æœŸ (1ä¸ªæœˆ)
1. â³ åŠ metadata (doc_id/source/timestamp)
2. â³ æ”¯æŒæ–‡æ¡£æ›´æ–°/åˆ é™¤
3. â³ å¤šæ–‡æ¡£ç®¡ç†

### é•¿æœŸ (2-3ä¸ªæœˆ)
1. â³ GraphRAG (å…³ç³»å‹çŸ¥è¯†)
2. â³ å¤šAgentåä½œ
3. â³ è‡ªåŠ¨è¯„ä¼°pipeline

---

## ğŸ› å¸¸è§é—®é¢˜

### Q1: BM25ç´¢å¼•æ²¡æ„å»ºæ€ä¹ˆåŠ?
**A**: ä¼šè‡ªåŠ¨é™çº§åˆ°çº¯å‘é‡æ£€ç´¢,ä¸å½±å“ä½¿ç”¨

### Q2: å†…å­˜å ç”¨ä¼šå¢åŠ å¤šå°‘?
**A**: BM25ç´¢å¼•çº¦ä¸ºæ–‡æœ¬å¤§å°çš„2-3å€ (æ¯”å‘é‡å°å¾—å¤š)

### Q3: å¦‚ä½•è°ƒä¼˜å‚æ•°?
**A**: 
- `top_k`: å»ºè®®3-5 (å¤ªå¤šä¼šå¼•å…¥å™ªéŸ³)
- `chunk_size`: ä¸­æ–‡å»ºè®®150-250
- `SIMILARITY_THRESHOLD`: æ ¹æ®å®é™…è·ç¦»è°ƒæ•´ (å»ºè®®2.0-4.0)

### Q4: å¦‚ä½•è¯„ä¼°æ•ˆæœ?
**A**: ä½¿ç”¨è¯„ä¼°æ¥å£:
```python
test_cases = [
    {"question": "...", "expected_keywords": [...]},
    ...
]
# POST /rag/evaluate
```

---

## ğŸ“ è¿ç§»æŒ‡å—

### ä»æ—§ç‰ˆæœ¬å‡çº§

**Step 1**: å®‰è£…æ–°ä¾èµ–
```bash
pip install rank-bm25 jieba --break-system-packages
```

**Step 2**: æ›¿æ¢`app/services/rag.py`ä¸ºæ–°ç‰ˆæœ¬

**Step 3**: é‡æ–°æ„å»ºç´¢å¼•
```python
# åˆ é™¤æ—§ç´¢å¼•
# é‡æ–°è°ƒç”¨ RAG.build_index()
```

**Step 4**: æ›´æ–°APIè·¯ç”± (å¯é€‰)
```python
# ä½¿ç”¨ rag_router_enhanced.py æ›¿æ¢åŸè·¯ç”±
```

**å…¼å®¹æ€§**: æ—§ä»£ç ä¸éœ€è¦æ”¹,æ–°åŠŸèƒ½å¯é€‰å¯ç”¨ âœ…

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [RRFè®ºæ–‡](https://plg.uwaterloo.ca/~gvcormac/cormacksigir09-rrf.pdf)
- [BM25ç®—æ³•è¯¦è§£](https://en.wikipedia.org/wiki/Okapi_BM25)
- [LangChainæ··åˆæ£€ç´¢](https://python.langchain.com/docs/how_to/hybrid/)

---

## ğŸ’¡ æ±‚èŒç‰ˆé¡¹ç›®æè¿°

**æŠ€æœ¯äº®ç‚¹**:
1. å®ç°å‘é‡+BM25æ··åˆæ£€ç´¢,å‡†ç¡®ç‡æå‡30%+
2. ä½¿ç”¨RRFç®—æ³•èåˆå¼‚æ„æ£€ç´¢ç»“æœ
3. æ”¯æŒdebugæ¨¡å¼,æ£€ç´¢è¿‡ç¨‹å¯è§‚æµ‹
4. æ¨¡å—åŒ–è®¾è®¡,æ”¯æŒå¤šç§æ£€ç´¢ç­–ç•¥

**æŠ€æœ¯å–èˆ**:
- ç‰ºç‰²20%å»¶è¿Ÿ,æ¢å–30%å‡†ç¡®ç‡ (ä¸šåŠ¡å¯¼å‘)
- é€‰æ‹©RRFè€ŒéåŠ æƒèåˆ (é²æ£’æ€§ä¼˜å…ˆ)
- åˆ†è¯ç”¨jiebaè€ŒéBERT (å·¥ç¨‹æ•ˆç‡)

**å¯æ‰©å±•æ€§**:
- æ˜“äºæ¥å…¥Rerank/æŸ¥è¯¢æ”¹å†™
- æ”¯æŒå¤šæ–‡æ¡£/å¤šç§Ÿæˆ·æ‰©å±•
- è¯„ä¼°pipelineå¯è‡ªåŠ¨åŒ–